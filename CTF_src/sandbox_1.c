#include "ruby.h"

#include <linux/seccomp.h>
#include <sys/prctl.h>

static VALUE
sandbox_seccomp(VALUE _mod) {
  unsigned char filter[] = {32, 0, 0, 0, 0, 0, 0, 0, 21, 0, 0, 1, 231, 0, 0, 0, 6, 0, 0, 0, 0, 0, 255, 127, 53, 0, 0, 1, 200, 0, 0, 0, 6, 0, 0, 0, 1, 0, 5, 0, 21, 0, 0, 1, 2, 0, 0, 0, 6, 0, 0, 0, 1, 0, 5, 0, 21, 0, 0, 1, 41, 0, 0, 0, 6, 0, 0, 0, 1, 0, 5, 0, 21, 0, 0, 1, 42, 0, 0, 0, 6, 0, 0, 0, 1, 0, 5, 0, 21, 0, 0, 1, 43, 0, 0, 0, 6, 0, 0, 0, 1, 0, 5, 0, 21, 0, 0, 1, 44, 0, 0, 0, 6, 0, 0, 0, 1, 0, 5, 0, 21, 0, 0, 1, 45, 0, 0, 0, 6, 0, 0, 0, 1, 0, 5, 0, 21, 0, 0, 1, 46, 0, 0, 0, 6, 0, 0, 0, 1, 0, 5, 0, 21, 0, 0, 1, 47, 0, 0, 0, 6, 0, 0, 0, 1, 0, 5, 0, 21, 0, 0, 1, 48, 0, 0, 0, 6, 0, 0, 0, 1, 0, 5, 0, 21, 0, 0, 1, 49, 0, 0, 0, 6, 0, 0, 0, 1, 0, 5, 0, 21, 0, 0, 1, 50, 0, 0, 0, 6, 0, 0, 0, 1, 0, 5, 0, 21, 0, 0, 1, 53, 0, 0, 0, 6, 0, 0, 0, 1, 0, 5, 0, 21, 0, 0, 1, 56, 0, 0, 0, 6, 0, 0, 0, 1, 0, 5, 0, 21, 0, 0, 1, 57, 0, 0, 0, 6, 0, 0, 0, 1, 0, 5, 0, 21, 0, 0, 1, 58, 0, 0, 0, 6, 0, 0, 0, 1, 0, 5, 0, 21, 0, 0, 1, 62, 0, 0, 0, 6, 0, 0, 0, 1, 0, 5, 0, 21, 0, 0, 1, 101, 0, 0, 0, 6, 0, 0, 0, 1, 0, 5, 0, 21, 0, 0, 1, 157, 0, 0, 0, 6, 0, 0, 0, 1, 0, 5, 0, 6, 0, 0, 0, 0, 0, 255, 127
  };
  struct A{
    size_t len;
    unsigned char* s;
  } a;
  a.len = sizeof(filter) / 8;
  a.s = filter;
  prctl(PR_SET_NO_NEW_PRIVS, 1, 0, 0, 0);
  if(prctl(PR_SET_SECCOMP, SECCOMP_MODE_FILTER, &a)) perror("prctl");

  return INT2NUM(0);
}

void Init_sandbox(void) {
  VALUE mSandbox = rb_define_module("Sandbox");
  rb_define_module_function(mSandbox, "run", sandbox_seccomp, 0);
}
